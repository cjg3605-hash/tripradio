name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]

env:
  NODE_VERSION: '18'
  CACHE_PATHS: |
    ~/.npm
    .next/cache

jobs:
  # ðŸ“‹ í’ˆì§ˆ ê²€ì‚¬
  quality-checks:
    name: ðŸ” Code Quality & Security
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: ðŸ” Lint check
        run: npm run lint

      - name: ðŸ“ Type check
        run: npm run type-check

      - name: ðŸ”’ Security audit
        run: npm run security:audit

      - name: ðŸ“Š Deployment check
        run: npm run deploy:check
        continue-on-error: true # í™˜ê²½ë³€ìˆ˜ ëˆ„ë½ì€ í—ˆìš©

  # ðŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
  build-test:
    name: ðŸ”¨ Build & Test
    runs-on: ubuntu-latest
    needs: quality-checks
    
    strategy:
      matrix:
        node-version: [18, 20]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: ðŸ” Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: nextjs-build-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          restore-keys: |
            nextjs-build-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-
            nextjs-build-${{ runner.os }}-

      - name: ðŸ—ï¸ Build application
        run: npm run build
        env:
          # ë”ë¯¸ í™˜ê²½ë³€ìˆ˜ë¡œ ë¹Œë“œ í…ŒìŠ¤íŠ¸
          GEMINI_API_KEY: dummy_test_key_for_ci_build_only
          GOOGLE_CLOUD_PROJECT: ci-test-project
          DATABASE_URL: sqlite://memory
          NEXTAUTH_SECRET: ci-test-secret-key-for-build-validation-only
          NEXTAUTH_URL: https://example.com

      - name: ðŸ“Š Build analysis
        run: |
          echo "ðŸ“¦ Build size analysis:"
          du -sh .next/
          echo "ðŸ“ Static pages count:"
          find .next/static -name "*.js" | wc -l

      - name: ðŸ’¾ Upload build artifacts
        if: matrix.node-version == '18' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: .next
          retention-days: 1

  # ðŸŽ¯ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  performance-test:
    name: âš¡ Performance Testing  
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'pull_request'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ’¾ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: .next

      - name: ðŸ Start application
        run: |
          npm run start &
          sleep 10
        env:
          PORT: 3000
          GEMINI_API_KEY: dummy_test_key_for_performance_test_only
          GOOGLE_CLOUD_PROJECT: performance-test-project
          DATABASE_URL: sqlite://memory
          NEXTAUTH_SECRET: performance-test-secret-key-for-validation-only
          NEXTAUTH_URL: http://localhost:3000

      - name: âš¡ Lighthouse performance audit
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ðŸš€ ë°°í¬ ì‹œë®¬ë ˆì´ì…˜ 
  deploy-simulation:
    name: ðŸŒ Deploy Simulation
    runs-on: ubuntu-latest
    needs: [quality-checks, build-test]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ’¾ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files  
          path: .next

      - name: ðŸŽ¯ Production readiness check
        run: |
          echo "ðŸ—ï¸ Verifying production build..."
          npm run deploy:check || echo "âš ï¸ Environment variables needed for production"
          
          echo "ðŸ“Š Build statistics:"
          echo "Build size: $(du -sh .next/ | cut -f1)"
          echo "Static files: $(find .next/static -type f | wc -l)"
          echo "Pages: $(find .next/server/pages -name "*.js" 2>/dev/null | wc -l)"
          
          echo "âœ… Production simulation complete"

      - name: ðŸ“‹ Deployment report
        run: |
          cat << EOF > deployment-report.md
          # ðŸš€ ë°°í¬ ì¤€ë¹„ ë¦¬í¬íŠ¸
          
          ## âœ… í’ˆì§ˆ ê²€ì¦ ì™„ë£Œ
          - ë¦°íŠ¸ ê²€ì‚¬: í†µê³¼
          - íƒ€ìž… ê²€ì‚¬: í†µê³¼  
          - ë³´ì•ˆ ê°ì‚¬: í†µê³¼
          
          ## ðŸ—ï¸ ë¹Œë“œ ê²€ì¦ ì™„ë£Œ
          - Node.js 18, 20 í˜¸í™˜ì„±: í™•ì¸
          - í”„ë¡œë•ì…˜ ë¹Œë“œ: ì„±ê³µ
          - ë²ˆë“¤ í¬ê¸°: $(du -sh .next/ | cut -f1)
          
          ## ðŸ“Š ë°°í¬ ê¶Œìž¥ì‚¬í•­
          - í™˜ê²½ë³€ìˆ˜ ì„¤ì • í•„ìˆ˜
          - HTTPS ì¸ì¦ì„œ ì¤€ë¹„
          - ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
          - ëª¨ë‹ˆí„°ë§ ë„êµ¬ ì„¤ì •
          
          EOF

      - name: ðŸ’¾ Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.md
          retention-days: 7

  # ðŸ§¹ ì •ë¦¬ ìž‘ì—…
  cleanup:
    name: ðŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [quality-checks, build-test, performance-test, deploy-simulation]
    if: always()

    steps:
      - name: ðŸ“‹ Job summary
        run: |
          echo "## ðŸŽ¯ CI/CD Pipeline ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ë‹¨ê³„ | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY  
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| í’ˆì§ˆ ê²€ì‚¬ | ${{ needs.quality-checks.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¹Œë“œ í…ŒìŠ¤íŠ¸ | ${{ needs.build-test.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ | ${{ needs.performance-test.result == 'success' && 'âœ… ì„±ê³µ' || needs.performance-test.result == 'skipped' && 'â­ï¸ ê±´ë„ˆëœ€' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë°°í¬ ì‹œë®¬ë ˆì´ì…˜ | ${{ needs.deploy-simulation.result == 'success' && 'âœ… ì„±ê³µ' || needs.deploy-simulation.result == 'skipped' && 'â­ï¸ ê±´ë„ˆëœ€' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **ë°°í¬ ì¤€ë¹„ ì™„ë£Œ!**" >> $GITHUB_STEP_SUMMARY