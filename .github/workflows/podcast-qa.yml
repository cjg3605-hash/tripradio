name: Podcast Generation QA Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/lib/ai/podcast/**'
      - 'src/lib/ai/tts/**' 
      - 'app/api/tts/**'
      - 'src/components/audio/**'
      - 'tests/podcast/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/lib/ai/podcast/**'
      - 'src/lib/ai/tts/**'
      - 'app/api/tts/**'
      - 'src/components/audio/**'
      - 'tests/podcast/**'
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œì— ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'
  
jobs:
  # 1. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ë° ë¦°íŒ…
  unit-tests:
    name: Unit Tests & Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run type check
        run: npm run type-check

      - name: Run unit tests
        run: npm run test:unit
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Upload unit test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: test-reports/unit/

  # 2. í†µí•© í…ŒìŠ¤íŠ¸
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: unit-tests
    
    strategy:
      matrix:
        language: ['ko', 'en', 'ja']
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run integration tests
        run: npm run test:integration
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TEST_LANGUAGE: ${{ matrix.language }}

      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results-${{ matrix.language }}
          path: test-reports/integration/

  # 3. ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí‚¹
  performance-tests:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: unit-tests
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run performance benchmarks
        run: npm run test:performance
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-test-results
          path: test-reports/performance/

      - name: Comment performance results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            try {
              const results = fs.readFileSync('test-reports/performance/benchmark-summary.json', 'utf8');
              const data = JSON.parse(results);
              
              const comment = `## ğŸš€ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí‚¹ ê²°ê³¼
              
              | í…ŒìŠ¤íŠ¸ | ì†Œìš”ì‹œê°„ | ëª©í‘œì‹œê°„ | ìƒíƒœ |
              |--------|----------|----------|------|
              | ì†Œí˜• ë°•ë¬¼ê´€ | ${data.small}ms | <15s | ${data.small < 15000 ? 'âœ…' : 'âŒ'} |
              | ì¤‘í˜• ë°•ë¬¼ê´€ | ${data.medium}ms | <30s | ${data.medium < 30000 ? 'âœ…' : 'âŒ'} |
              | ëŒ€í˜• ë°•ë¬¼ê´€ | ${data.large}ms | <60s | ${data.large < 60000 ? 'âœ…' : 'âŒ'} |
              
              **ì „ì²´ ê°œì„ ë¥ **: ${data.improvement}% (ê¸°ì¤€: 79ì´ˆ â†’ ëª©í‘œ: 30ì´ˆ)`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('ë²¤ì¹˜ë§ˆí‚¹ ê²°ê³¼ ëŒ“ê¸€ ìƒì„± ì‹¤íŒ¨:', error);
            }

  # 4. ì¥ì•  ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸
  failure-scenarios:
    name: Failure Scenario Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: unit-tests
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run failure scenario tests
        run: npm run test:failure
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Upload failure test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: failure-test-results
          path: test-reports/failure/

  # 5. E2E í…ŒìŠ¤íŠ¸ (Playwright)
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: [unit-tests, integration-tests]
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        include:
          - browser: chromium
            os: ubuntu-latest
          - browser: firefox  
            os: ubuntu-latest
          - browser: webkit
            os: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Run E2E tests
        run: npx playwright test --project=${{ matrix.browser }}
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results-${{ matrix.browser }}
          path: test-results/

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}
          path: test-reports/playwright-report/

  # 6. í’ˆì§ˆ ë¦¬í¬íŠ¸ ìƒì„±
  quality-report:
    name: Generate Quality Report
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, performance-tests, failure-scenarios, e2e-tests]
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: all-test-results/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Generate quality report
        run: |
          node scripts/generate-quality-report.js all-test-results/
        
      - name: Upload quality report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: quality-report/

      - name: Comment quality summary
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            try {
              const summary = fs.readFileSync('quality-report/summary.json', 'utf8');
              const data = JSON.parse(summary);
              
              const comment = `## ğŸ“Š íŒŸìºìŠ¤íŠ¸ QA í’ˆì§ˆ ë¦¬í¬íŠ¸
              
              ### í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
              - **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸**: ${data.unit.passed}/${data.unit.total} í†µê³¼ (${data.unit.coverage}% ì»¤ë²„ë¦¬ì§€)
              - **í†µí•© í…ŒìŠ¤íŠ¸**: ${data.integration.passed}/${data.integration.total} í†µê³¼
              - **ì„±ëŠ¥ í…ŒìŠ¤íŠ¸**: ${data.performance.passed}/${data.performance.total} í†µê³¼
              - **ì¥ì•  ì‹œë‚˜ë¦¬ì˜¤**: ${data.failure.passed}/${data.failure.total} í†µê³¼  
              - **E2E í…ŒìŠ¤íŠ¸**: ${data.e2e.passed}/${data.e2e.total} í†µê³¼
              
              ### í•µì‹¬ ì§€í‘œ
              - **98-99% ì‹¤íŒ¨ìœ¨ í•´ê²°**: ${data.metrics.failureRateReduced ? 'âœ…' : 'âŒ'}
              - **30ì´ˆ ì„±ëŠ¥ ëª©í‘œ**: ${data.metrics.performanceTarget ? 'âœ…' : 'âŒ'} (í‰ê· : ${data.metrics.avgTime}ms)
              - **íƒ€ì„ì•„ì›ƒ ë¬¸ì œ í•´ê²°**: ${data.metrics.timeoutFixed ? 'âœ…' : 'âŒ'}
              - **ì „ì²´ í’ˆì§ˆ ì ìˆ˜**: ${data.metrics.qualityScore}/100
              
              ${data.recommendations.length > 0 ? '### ğŸ”§ ê°œì„  ê¶Œì¥ì‚¬í•­\n' + data.recommendations.map(r => `- ${r}`).join('\n') : ''}
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('í’ˆì§ˆ ë¦¬í¬íŠ¸ ëŒ“ê¸€ ìƒì„± ì‹¤íŒ¨:', error);
            }

  # 7. ë°°í¬ ì „ ìµœì¢… ê²€ì¦ (main ë¸Œëœì¹˜ë§Œ)
  pre-deployment-validation:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [unit-tests, integration-tests, performance-tests, failure-scenarios, e2e-tests]
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run comprehensive validation
        run: npm run test:validate-deployment
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Validate database migrations
        run: npm run db:validate

      - name: Check for breaking changes
        run: npm run check:breaking-changes

      - name: Final quality gate
        run: |
          echo "ğŸ¯ ë°°í¬ ì „ ìµœì¢… ê²€ì¦ ì™„ë£Œ"
          echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼"
          echo "âœ… ì„±ëŠ¥ ê¸°ì¤€ ë‹¬ì„±"
          echo "âœ… í’ˆì§ˆ ê¸°ì¤€ ì¶©ì¡±"

# ìŠ¤ì¼€ì¤„ëŸ¬ ì•Œë¦¼ (ë§¤ì¼ í…ŒìŠ¤íŠ¸ ê²°ê³¼)
  daily-health-check:
    name: Daily Health Check
    runs-on: ubuntu-latest
    if: github.event.schedule
    needs: [unit-tests, integration-tests, performance-tests, failure-scenarios, e2e-tests]
    
    steps:
      - name: Send daily report
        uses: actions/github-script@v7
        with:
          script: |
            // Slack/Discord ë“±ìœ¼ë¡œ ì¼ì¼ í—¬ìŠ¤ì²´í¬ ê²°ê³¼ ì „ì†¡
            console.log('ğŸ“Š ì¼ì¼ íŒŸìºìŠ¤íŠ¸ ì‹œìŠ¤í…œ í—¬ìŠ¤ì²´í¬ ì™„ë£Œ');
            
            // ì›¹í›… URLì´ ìˆìœ¼ë©´ ì•Œë¦¼ ì „ì†¡
            if (process.env.DAILY_REPORT_WEBHOOK) {
              const webhook = process.env.DAILY_REPORT_WEBHOOK;
              // ì‹¤ì œ ì•Œë¦¼ ë¡œì§ êµ¬í˜„
            }