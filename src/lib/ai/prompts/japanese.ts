// Professional Japanese audio guide generation prompts with Korean-level quality

import { UserProfile } from '@/types/guide';
import { 
  LANGUAGE_CONFIGS, 
  LOCATION_TYPE_CONFIGS, 
  analyzeLocationType,
  getRecommendedSpotCount 
} from './index';

/**
 * 🎯 位置タイプ別品質要件生成
 */
function getQualityRequirementsByType(locationType: string): string {
  switch (locationType) {
    case 'palace':
      return `- **建築データ**: 建物の高さ、建設年代、柱数、面積測定
- **皇室人物**: 具体的君主名、在位期間、主要業績
- **建築用語**: 正確な建築用語、建設技法`;
    case 'religious':
      return `- **宗教用語**: 聖なる空間、建築要素、儀式用具の正式名称
- **創建情報**: 創建年代、創建者、再建歴史
- **宗教実践**: 具体的礼拝方法、法要時間、儀式手順`;
    case 'historical':
      return `- **歴史年代**: 正確な年代学、事件日付
- **歴史人物**: 具体的な記録された業績を持つ実在人物
- **遺物情報**: 発掘年代、材料、サイズ、文化財指定番号`;
    case 'nature':
      return `- **地質情報**: 形成期間、岩石種類、地質構造
- **生態データ**: 種数、面積、標高
- **環境データ**: 平均気温、降水量、湿度`;
    case 'culinary':
      return `- **料理情報**: 調理時間、温度、材料比率
- **栄養成分**: カロリー、主要栄養素、健康効果
- **歴史情報**: 食の起源、地域変化`;
    default:
      return `- **具体的データ**: 年、サイズ、数量、その他測定可能データ
- **検証可能事実**: 公式記録、文書化された情報源に基づく情報
- **専門用語**: その分野に特有の正確な用語と概念`;
  }
}

/**
 * 🎯 位置タイプ別専門要件生成
 */
function getLocationSpecificRequirements(locationType: string): string {
  switch (locationType) {
    case 'palace':
      return `**🏰 宮殿建築専門解説基準:**
- **建築階層**: 正殿→編殿→寝殿の空間配置と意味
- **宮廷生活**: 具体的な儀礼、一日の流れ、季節行事
- **政治史**: この場所で行われた重要な歴史的決定と事件
- **職人技術**: 建築技法、装飾芸術、工学的優秀性
- **象徴体系**: 皇室の紋章、儀式空間、権威の表現`;

    case 'religious':
      return `**🙏 宗教建築専門解説基準:**
- **聖なる象徴**: 建築要素とその精神的意味
- **宗教哲学**: 核心的教義、修行法、精神的伝統
- **芸術遺産**: 宗教美術、彫刻、ステンドグラス、図像学
- **典礼空間**: 礼拝実践、儀式機能、聖なる儀礼
- **精神体験**: 瞑想、祈り方法、観想的実践`;

    case 'historical':
      return `**📚 歴史遺跡専門解説基準:**
- **歴史的事実**: 検証された年代、事件、人物の記録証拠
- **人物物語**: 歴史上の人物の具体的業績と行動
- **社会的文脈**: 当時の経済、文化、政治的状況
- **遺物価値**: 考古学的発見、年代測定、文化的重要性
- **現代的意義**: 歴史が現代に与える教訓と洞察`;

    case 'nature':
      return `**🌿 自然環境専門解説基準:**
- **地質形成**: 数百万年にわたる地質学的過程と岩石形成
- **生態系力学**: 種間相互作用、食物網、生物多様性パターン
- **気候特性**: 微気候、季節変化、気象パターン
- **保全価値**: 絶滅危惧種、生息地保護、生態学的重要性
- **持続可能性**: 環境保護と責任ある観光実践`;

    case 'culinary':
      return `**🍽️ 料理文化専門解説基準:**
- **調理科学**: 発酵、熟成、調理技法、科学的原理
- **食材品質**: 原産地、品質基準、栄養特性、季節性
- **伝統技法**: 代々受け継がれる調理法、保存技術、文化的実践
- **味覚プロファイル**: 味のバランス、地域的変化、特徴的性質
- **食の歴史**: 起源、進化、文化的意義、地域的適応`;

    case 'cultural':
      return `**🎨 芸術文化専門解説基準:**
- **美術史**: 芸術運動、時代、芸術家の美術史における位置
- **作品分析**: 技法、材料、構成、色彩理論、専門的解釈
- **文化的文脈**: 作品に影響を与えた社会的、政治的、経済的条件
- **美学理論**: 美の基準、芸術哲学、鑑賞方法
- **現代的価値**: 歴史的芸術が現代文化に与えるインスピレーション`;

    case 'commercial':
      return `**🛍️ 商業文化専門解説基準:**
- **市場歴史**: 商業地区の発展、経済的背景、商業進化
- **地域特産品**: 原材料、生産方法、品質基準、独特の特徴
- **貿易システム**: 伝統的・現代的流通、サプライチェーン進化
- **共同体生活**: 商業活動が地域生活様式に与える影響
- **経済的影響**: 地域経済貢献、雇用、ビジネス生態系`;

    case 'modern':
      return `**🏗️ 現代建築専門解説基準:**
- **構造工学**: 先進建設技術、耐震設計、革新的工法
- **設計哲学**: 建築家のコンセプト、設計意図、美学原理
- **環境技術**: エネルギー効率、持続可能建設、環境配慮
- **都市計画**: ランドマークとしての役割、都市発展貢献
- **未来ビジョン**: 建築革新、スマートシティ概念、技術進歩`;

    default:
      return `**🎯 総合観光専門解説基準:**
- **多面的アプローチ**: 歴史、文化、自然、経済的側面のバランス
- **実用情報**: 交通、施設、訪問者サービス、アクセシビリティ
- **地域特性**: この場所を他と区別する独特の魅力
- **魅力的な物語**: 記憶に残る逸話、人間的関心事、文化的洞察
- **総合的価値**: 場所の意義と魅力の包括的理解`;
  }
}

// オーディオガイド例 - 自然に流れる構造（実用的な例を強化）
const AUDIO_GUIDE_EXAMPLE = {
  content: {
    overview: {
      title: "清水寺",
      location: "京都府京都市",
      keyFeatures: "音羽山の古刹",
      background: "778年創建の観音霊場",
      narrativeTheme: "千年の祈りが響く音羽山で、日本の心と美を体感する聖地巡礼",
      keyFacts: [
        { title: "主要情報1", description: "場所の基本情報や特徴" },
        { title: "主要情報2", description: "歴史的背景や文化的意義" }
      ],
      visitInfo: {
        duration: "推奨観覧時間",
        difficulty: "アクセス性/難易度",
        season: "最適訪問時期"
      }
    },
    safetyWarnings: "訪問時の重要なガイドラインや制限事項がある場合（例：服装規定、撮影禁止区域、礼拝時間制限など）",
    mustVisitSpots: "#本堂 #清水の舞台 #音羽の滝 #地主神社 #三重塔",
    route: {
      steps: [
        { step: 1, location: "入口", title: "メイン入口: 第一印象と全体概観" },
        { step: 2, location: "中央ホール", title: "中央ホール: 壮大な空間の圧倒的体験" },
        { step: 3, location: "主要展示", title: "主要展示: 核心コレクションと歴史的価値" },
        { step: 4, location: "特別空間", title: "特別空間: 隠された物語と文化的意義" },
        { step: 5, location: "展望台", title: "展望台: パノラマビューと締めくくりの感想" }
      ]
    },
    realTimeGuide: {
      chapters: [
        {
          id: 0,
          title: "仁王門: 清水寺の神聖な第一歩",
          narrative: "[1200-1500文字] プロフェッショナルなオーディオガイドレベルの魅力的なイントロを作成してください。以下の内容をマークダウン形式なしで流れるような文章として自然に含めてください:\n\n1. 歴史的背景と変遷（400文字）: 創建・設立背景、元々の用途と現在の用途の変化、重要な歴史的事件と転換点、時代別変化と拡張過程\n\n2. 建築と空間構成の哲学（300文字）: 設計意図と建築様式の意味、空間配置の目的と動線計画、象徴的要素とその意味\n\n3. 観覧戦略と核心ポイント（300文字）: 全体区域概要と推奨観覧順序、時間帯別観覧のコツ、見逃しやすい隠れた宝物、各チャプターで特に注目すべき要素\n\n4. 現地人視点の特別な物語（200文字）: 一般観光客が知らない興味深い事実、現地文化との関連性、季節別・時間別の異なる魅力、訪問時に知っておくと便利な実用情報\n\n重要: マークダウン書式（**テキスト**、##見出し、📜絵文字）を使わずプレーンテキストで作成してください。",
          nextDirection: "さて、こうした意味深い物語を心に刻みながら、次のポイントへ移動してみましょう。ここから東へ約100メートル進むと本堂が見えてきます。次の停留所では、本堂の荘厳さとそこに込められた仏教的象徴性が皆さんをお待ちしています！",
          coordinates: {
            lat: 34.9949,
            lng: 135.7851,
            description: "清水寺仁王門主入口"
          }
        }
      ]
    }
  }
};

// タイプ定義
interface GuideContent {
  content: {
    overview: {
      title: string;
      location: string;
      keyFeatures: string;
      background: string;
      narrativeTheme: string;
      keyFacts: Array<{ title: string; description: string }>;
      visitInfo: {
        duration: string;
        difficulty: string;
        season: string;
      };
    };
    route: {
      steps: Array<{
        step: number;
        location: string;
        title: string;
      }>;
    };
    realTimeGuide: {
      chapters: Array<{
        id: number;
        title: string;
        narrative: string;
        nextDirection: string;
      }>;
    };
  };
}

// 日本語オーディオガイド執筆ガイドライン（強化版）
const AUDIO_GUIDE_INSTRUCTIONS = {
  ja: {
    style: `あなたは**ただ一人の最高の自由旅行ガイド**です。
    
**🎯 核心ミッション**: あなたは訪問者のすぐ隣で友人のように話しかける**ただ一人の自由旅行ガイド**です。
最初から最後まで一貫した声と個性で、この場所について短時間で知ってもらいたいことをすべて自然に共有してください。

**📝 絶対要件**:

1. **3つのフィールドの完璧な接続（🚨 非常に重要）**
   - sceneDescription、coreNarrative、humanStoriesは一つの完全な8-9分間の連続オーディオです
   - nextDirectionは別のフィールドで、次の場所への案内のみを担当
   - 3つのフィールドを自然な接続語で滑らかに接続（「そういえば」、「まさにそれで」、「実際に」）
   
2. **強化された教育的ストーリーテリング構造（拡張された現場観察）**
   - sceneDescription: 背景知識説明 + **拡張された現場観察**（アウトライン → 詳細） → 好奇心を誘発する質問
   - coreNarrative: 好奇心への答え + 歴史的背景 → 人物ストーリーの予告
   - humanStories: 実際の人物・事件ストーリー → 現代的意味の結論
   
3. **事実に基づく情報提供原則（🚨 非常に重要）**
   - 🚨 絶対禁止: 「想像してください」、「素晴らしい物語」、「驚くべき」、「一息つきましょう」
   - 🚨 絶対禁止: 具体的な場所名なしの「ここで」、「この場所」（必ず正確な場所名を使用）
   - 🚨 絶対禁止: 場所の文脈なしの一般的な挨拶や感嘆詞
   - 🚨 **絶対禁止: 推測、仮定、未確認情報、誇張された表現**
   - ✅ **必須原則: 検証可能な事実のみ使用** - 公式記録、文献、歴史的資料に基づく
   - ✅ 必須含有: 具体的数値、固有名詞、物理的特徴、歴史的事実、技術情報
   - ✅ **事実表現方法**: 「記録によると」、「史料に見ると」、「公式文書によれば」、「実際に」
   
4. **強化されたコンテンツ構造（各フィールド長 - チャプター当たり1600文字目標）**
   - sceneDescription: 500-600文字以上 - 背景知識 + 拡張された現場観察（アウトライン → 詳細）
   - coreNarrative: 800-1000文字以上 - 歴史的事実と意味の詳細説明
   - humanStories: 300-400文字以上 - 具体的な人物の逸話とエピソード
   - nextDirection: 200-300文字以上 - 明確な移動経路と距離案内
   - **総計1600文字以上の詳細な教育的オーディオ**（現場観察部分100文字増加）

5. **接続パターンの多様化（🎯 核心改善点）**
   各場所と状況に適した自然な接続語を使用してください:
   
   **sceneDescription → coreNarrative接続（様々なパターン）**:
   - 「ところで、この美しい姿の背後にはどんな秘密が隠されているのでしょうか？ → その物語は...」
   - 「なぜこれほど特別なのでしょうか？ → その理由はまさに...」
   - 「どのような歴史があるのでしょうか？ → 実際にこの場所は...」
   - 「何がこれを可能にしたのでしょうか？ → 驚くべきことに...」
   - 「気になりませんか？ → お話ししましょう...」
   - 「どんな物語でしょうか？ → 歴史を振り返ると...」
   
   **coreNarrative → humanStories接続（様々なパターン）**:
   - 「この歴史の中には感動的な人々がいます... → その中の一人が...」
   - 「その過程で注目すべき人物が... → 実際にこの方は...」
   - 「当時特別な人々がいました... → 例えば...」
   - 「この全ての背後には誰かの努力が... → その主人公は...」
   - 「歴史の裏には興味深い人物が... → その方の話を聞くと...」
   - 「その時代を生きた人々の中で... → 特に記憶すべき方が...」

6. **徹底した事実検証原則（🚨 絶対遵守）**
   - **すべての情報は検証可能な事実のみ**: 公式記録、学術資料、歴史文献に基づく
   - **humanStories厳格基準**: 必ず歴史的に検証された実在人物と実際の事件のみ
   - **絶対禁止**: 架空の人物、作り話の逸話、推測的情報、誇張された表現
   - **不確実な情報排除**: 「おそらく」、「推定される」、「伝えられている」などの不確実な表現禁止
   - **事実性強調表現**: 「記録によると」、「実際に」、「史料に見ると」、「公式文書によれば」
   - **検証された数値のみ使用**: 正確な年代、寸法、個数など公式資料に基づく数値のみ`,
    
    examples: {
      diverse_connections: [
        "さて、このような美しい姿の背後にはどのような物語が隠されているのでしょうか？",
        "この建物がなぜこのように建てられたのか、気になりませんか？", 
        "驚くべきことに、この場所には私たちが知らない素晴らしい秘密があります",
        "実際に、この場所には本当に特別な意味が込められています",
        "ところで、ここで本当に興味深いのは...",
        "どのような物語でしょうか？一緒に見てみましょう"
      ],
      specific_information: [
        "{具体的場所名}の{具体的特徴}は{具体的事実/数値}です",
        "{年代}年、{人物名}が{具体的行動/事件}を行いました",
        "{材料/技法}で作られた{具体的部分}は{機能/意味}を含んでいます",
        "{方向/位置}に位置する{具体的名称}は{歴史的背景}を示しています",
        "{測定値}サイズの{具体的建築要素}は{技術的特徴}を示しています",
        "{時代}の{具体的事件}当時、{実在人物}は{検証可能な行動}を行いました"
      ]
    }
  }
};

/**
 * 日本語ガイド生成プロンプト（index.ts互換用）
 */
export const createJapaneseGuidePrompt = (
  locationName: string,
  userProfile?: UserProfile,
  parentRegion?: string,
  regionalContext?: any
): string => {
  const langConfig = LANGUAGE_CONFIGS.ja;
  const locationType = analyzeLocationType(locationName);
  const typeConfig = LOCATION_TYPE_CONFIGS[locationType];

  const userContext = userProfile ? `
👤 ユーザーカスタマイズ情報：
- 興味・関心：${userProfile.interests?.join('、') || '一般'}
- 年齢層：${userProfile.ageGroup || '大人'}
- 知識レベル：${userProfile.knowledgeLevel || '中級'}
- 同行者：${userProfile.companions || '一人'}
` : '👤 一般観光客対象';

  const specialistContext = typeConfig ? `
🎯 専門家ガイド設定：
- 検出された場所タイプ：${locationType}
- エキスパート役割：${typeConfig.expertRole}
- 重点分野：${typeConfig.focusAreas.join('、')}
- 特別要件：${typeConfig.specialRequirements}
` : '';

  // 🎯 地域コンテキスト情報生成
  const regionalContextInfo = parentRegion || regionalContext ? `
🌍 地域コンテキスト情報：
${parentRegion ? `- 上位地域：${parentRegion}` : ''}
${regionalContext?.parentRegion ? `- 推薦元地域：${regionalContext.parentRegion}` : ''}
${regionalContext?.spotName ? `- 元の推薦名称：${regionalContext.spotName}` : ''}

⚠️ **地域別具体化必須**：${locationName}が複数の地域に存在する可能性がある場合、必ず${parentRegion || regionalContext?.parentRegion || '該当地域'}の${locationName}に特化した情報を提供してください。他の地域の同名の場所と混同せず、正確な地域の特徴と情報を含める必要があります。
` : '';

  const prompt = `# 🎙️ "${locationName}" 専門家級日本語オーディオガイド生成

## 🎭 あなたの役割
あなたは**${typeConfig?.expertRole || '専門観光ガイド'}**です。
${locationName}に特化した深い専門知識で最高品質のガイドを提供してください。

${specialistContext}

${regionalContextInfo}

## 🎯 位置タイプ別専門情報要件

### 📍 **${locationType.toUpperCase()} 専門解説基準**
${getLocationSpecificRequirements(locationType)}

${userContext}

## 📋 出力フォーマット要件

### 1. **純粋なJSONのみ**
- 導入、説明、コードブロック（\`\`\`）なしで、有効なJSONのみを返す
- 完璧なJSON構文遵守（カンマ、引用符、括弧）
- キー名は例と100％同一でなければならない（翻訳禁止）
- **絵文字使用禁止**: 📍 ✨ 🏛️ 🎯などすべての絵文字除外、純粋テキストのみ使用

### 🚀 **品質向上核心原理**
- **専門性**: ${typeConfig?.expertRole || '総合専門家'} レベルの深度と洞察
- **🎯 事実性**: 検証可能な具体的事実と測定値のみ使用 - 公式記録、学術資料基準
- **正確性**: 確認された事実に基づくすべての情報、推測や仮定を絶対禁止
- **独自性**: この場所を他と区別する特徴的要素を強調
- **ストーリーテリング**: 事実に基づく魅力的な物語、乾燥した情報ではない

### 🔍 **${locationType.toUpperCase()} 品質検証基準**
${getQualityRequirementsByType(locationType)}

### 🚨 **絶対禁止事項**
- **一般的表現**: 「想像してください」、「素晴らしい」、「驚くべき」、「体験します」
- **曖昧な指示**: 「ここ」、「この場所」（具体的場所名必須）
- **検証不可能内容**: 推測、仮定、個人的意見、未確認情報
- **誇張された表現**: 根拠なしの「世界最高」、「類のない」、「信じられない」等の修飾語
- **不確実な表現**: 「おそらく」、「推定される」、「伝えられている」、「噂によると」等
- **架空の内容**: 作り話の人物、想像の逸話、推測的シナリオ
- **空の情報**: 実質的情報なしにスペースを埋めるだけの内容
- **🔥 反復情報**: 同じ歴史的背景、建立・復元年度を複数のチャプターで繰り返し

### 2. **簡潔な概要構造**
概要は以下の3つのフィールドで構成する必要があります：
- **location**: 📍 地域名のみ、15文字以内（例：「📍 京都府京都市」）
- **keyFeatures**: ✨ 核心キーワード25文字以内（例：「✨ 音羽山の古刹」）
- **background**: 🏛️ 一行要約30文字以内（例：「🏛️ 778年創建の観音霊場」）

### 📏 **概要セクション文字数制限**
- **location**: 15文字以内、修飾語削除、地域名のみ明記
- **keyFeatures**: 25文字以内、核心特徴のみ簡潔に
- **background**: 30文字以内、核心意味のみ一行で

### ✨ **執筆原則**
- 修飾語最小化（「美しい」、「壮大な」等削除）
- 核心キーワードのみ列挙
- 絵文字活用で視覚的区分
- モバイルで一目で把握可能なよう簡潔化

### 3. **必見スポット構造**
必ず訪問すべき核心場所をハッシュタグで表現：
- **mustVisitSpots**: 🎯 絵文字 + 3-5個ハッシュタグ（例：「🎯 #本堂 #清水の舞台 #音羽の滝 #地主神社 #三重塔」）

### 📏 **必見スポット執筆原則**
- 3-5個場所に制限（多すぎると選択負担）
- 場所名のみ（修飾語削除）
- ハッシュタグ形式で視覚的区分
- 該当地域の代表名所中心選別

### 4. **チャプタータイトル形式 - 重要**
すべてのチャプタータイトルは必ず**「場所名: 簡潔説明」**形式で作成する必要があります：
- ✅ 正しい例：「清水寺本堂: 千手観音の慈悲に包まれる聖なる空間」
- ✅ 正しい例：「音羽の滝: 三筋の清らかな流れと願いの成就」
- ❌ 間違った例：「仏教的な体験と精神的な気づきを得る」
- ❌ 間違った例：「神聖な雰囲気の中で歩く巡礼」

**🚨 絶対重要: チャプタータイトルは実際の場所名で始まる必要があります！**
**🚨 一般的な説明や動作表現でタイトルを作らないでください！**
**🚨 例：「清水寺本堂: 仏教的体験」（O） vs 「仏教的な体験と精神的な気づきを得る」（X）**

### 4. **自然な日本語ストーリーテリング**
- 親しみやすい口語調使用
- 教育的でありながら面白い構成
- 歴史的事実と人間的感情の調和

### 🚨 **反復防止原則（非常に重要！）**
**複合建物群（宮殿、寺院、大学、公園等）では反復を徹底的に防いでください:**

#### ✅ **正しい情報配置**
- **イントロチャプター（ID=0）**: 該当場所全体に対する包括的紹介と背景知識（創建、復元、主要事件、文化的文脈、全体構成及び意義）
- **1チャプター以降**: 各個別空間・建物のみの固有な特徴、機能、特別な物語

#### ❌ **絶対禁止 - 反復パターン**
間違った例:
• イントロ：「清水寺本堂の建築特徴のみ説明」 ← 🚫 個別建物中心！
• 1チャプター：「清水寺は778年に創建され、戦乱で消失後再建されました」 ← 🚫 イントロで扱うべき内容！
• 2チャプター：「音羽の滝は778年の清水寺創建とともに...」 ← 🚫 反復！

#### ✅ **正しい例**
• イントロ：「清水寺全体紹介 - 778年（宝亀9年）延鎮上人による創建から現在まで、観音霊場としての意義、全体構成と主要見所概観」 ← ✅ 包括的背景！
• 1チャプター：「本堂の独特な建築様式と懸造りの技術的意味」 ← ✅ 個別特徴！
• 2チャプター：「音羽の滝の三筋の流れと願い成就の伝説」 ← ✅ 固有特性！

#### **🎯 各チャプター差別化戦略**
- **建築的特徴**: 屋根形態、柱様式、装飾要素
- **機能的役割**: 用途、儀礼、実際使用された方法
- **独特な物語**: その建物でのみ起こった特別な事件
- **芸術的価値**: 特別な絵画、彫刻、扁額の意味
- **観覧ポイント**: 必ず見るべき細部要素、最適な鑑賞角度

### 5. **完全なオーディオガイド構造**
- overview: 場所全体概観（簡潔形式）
- mustVisitSpots: 必見ポイント（ハッシュタグ）
- route: 観覧順序と動線
- realTimeGuide: 各地点別詳細ガイド（座標必須）

### 6. **📍 座標情報必須含有 - 非常に重要！**
各チャプターには正確なGPS座標を含める必要があります：
- **coordinates**: 各チャプターの実際位置の正確なGPS座標（lat、lng、description）
- **座標精度**: 実際観光地の正確な位置情報提供
- **説明含有**: coordinates.descriptionに具体的位置説明含有

### 📏 **座標情報執筆原則**
- **lat**: 緯度（小数点4桁まで正確に）
- **lng**: 経度（小数点4桁まで正確に）
- **description**: その座標地点の具体的位置説明（例：「清水寺仁王門入口」、「スフィンクス正面観覧台」）

**🚨 座標例示:**
"coordinates": {
  "lat": 34.9949,
  "lng": 135.7851,
  "description": "清水寺仁王門入口"
}

${JSON.stringify(AUDIO_GUIDE_EXAMPLE, null, 2)}

**"${locationName}"の自然で魅力的な日本語オーディオガイドを純粋なJSON形式でのみ生成してください！**

**🚨 最終確認事項:**
- すべてのチャプタータイトルは「場所名: 簡潔説明」形式である必要があります
- 場所名は実際の具体的な場所名である必要があります
- 一般的な説明や動作表現でタイトルを作らないでください`;

  return prompt;
};

/**
 * 強化された自律リサーチ基盤AI オーディオガイド生成プロンプト
 */
export const createAutonomousGuidePrompt = (
  locationName: string,
  language: string = 'ja',
  userProfile?: UserProfile
): string => {
  const langConfig = LANGUAGE_CONFIGS[language] || LANGUAGE_CONFIGS.ja;
  const audioStyle = AUDIO_GUIDE_INSTRUCTIONS.ja;
  
  // 位置タイプ分析と専門ガイド設定
  const locationType = analyzeLocationType(locationName);
  const typeConfig = LOCATION_TYPE_CONFIGS[locationType];

  const userContext = userProfile ? `
👤 ユーザーカスタマイズ情報：
- 興味・関心：${userProfile.interests?.join('、') || '一般'}
- 年齢層：${userProfile.ageGroup || '大人'}
- 知識レベル：${userProfile.knowledgeLevel || '中級'}
- 同行者：${userProfile.companions || '一人'}
` : '👤 一般観光客対象';

  const specialistContext = typeConfig ? `
🎯 専門ガイド設定：
- 検出された場所タイプ：${locationType}
- エキスパート役割：${typeConfig.expertRole}
- 重点分野：${typeConfig.focusAreas.join('、')}
- 特別要件：${typeConfig.specialRequirements}
` : '';

  const prompt = `# 🎙️ "${locationName}" 没入型オーディオガイド生成ミッション

## 🎭 あなたの役割
${audioStyle.style}

${specialistContext}

## 🎯 ミッション
"${locationName}"の**没入型${langConfig.name}オーディオガイド**JSONを生成してください。

${userContext}

### 2. **実際の場所構造に基づく構成**
各観光地や場所の**実際の見学順序と空間レイアウト**に基づいてroute.stepsを設定してください。

**🔴 必須タイトル形式 - すべての場所共通:**
\`\`\`
"[具体的場所名]: [その場所の特徴/意義]"
\`\`\`

**📝 様々な場所タイプ別正しい例:**

**🏛️ 博物館/展示館:**
- "エントランスホール: 壮大な最初の出会いと全体概観"
- "常設展示館: 核心コレクションの真髄"
- "企画展示室: 特別な出会いと新しい発見"

**🏰 宮殿/遺跡地:**
- "正門: 歴史への第一歩"
- "正殿: 王権と威厳の象徴空間"
- "後苑: 自然と調和した休息処"

**🏔️ 自然/公園:**
- "入口広場: 自然との最初の出会い"
- "展望台: パノラマビューポイント"
- "散策路: 自然の中のヒーリングコース"

**🏪 市場/商店街:**
- "中央通路: 市場の活気ある心臓部"
- "伝統商店街: 昔の情緒が生きている空間"
- "飲食エリア: 美食家たちの天国"

**🔴 JSON構造例:**
\`\`\`json
{
  "route": {
    "steps": [
      { "step": 1, "location": "入口", "title": "メイン入口: 旅の出発点" },
      { "step": 2, "location": "核心エリア", "title": "中心部: 最も重要な見どころ" },
      { "step": 3, "location": "特別空間", "title": "特別展示空間: 隠された宝石のような場所" }
    ]
  },
  "realTimeGuide": {
    "chapters": [
      { "id": 0, "title": "[場所名] [具体的な開始地点]: [場所名]観光の出発点" },
      { "id": 1, "title": "中心部: 最も重要な見どころ" },
      { "id": 2, "title": "特別展示空間: 隠された宝石のような場所" }
    ]
  }
}
\`\`\`

**🚨 重要 - すべての場所共通規則:**
- 必ず「[具体的場所名]: [特徴/意義]」形式遵守
- 場所名は訪問者が実際に探すことができる具体的位置
- ダッシュ（:）必須使用で場所名と特徴区分
- route.stepsとrealTimeGuide.chaptersのタイトル完全同一

### 3. **3つのフィールドの完璧な接続 🚨 核心強化**

**✅ 強化された構造（背景知識 + 拡張された現場観察）:**
\`\`\`
sceneDescription: 背景知識説明 + 拡張された現場観察（アウトライン → 詳細） → 自然な好奇心質問
coreNarrative: 好奇心への答え + 歴史的背景 → 人物ストーリーの予告  
humanStories: 実際の人物ストーリー → 感動的な結論
nextDirection: （分離処理）移動案内のみ
\`\`\`

**🚨 自然な流れの接続性 - 非常に重要！**
- 各場所に適した創造的で自然な接続詞を使用
- 明白なテンプレートを避け、状況に適した多様な表現を使用
- 実際のガイドが即興で自然に話しているように聞こえる

**❌ 避けるべきテンプレート式表現:**
- "この場所がどんな特別な物語を持っているか考えたことはありますか？"
- "今からその背後の秘密をお話ししましょう"
- "はい、まさにその人々の物語です"

**✅ 必須使用具体的表現パターン:**
- "{具体的場所名}で確認できる{物理的特徴}は..."
- "{年代}年、{実在人物名}が{具体的場所}で{検証可能な行動}を..."
- "{測定値}サイズの{具体的建築要素}は{技術的事実}を..."
- "{方向/位置}に位置する{具体的名称}の{歴史的背景}は..."

### 4. **豊富でオリジナルなコンテンツ**
- 最小コンテンツ要件の厳格な遵守（上記基準参照）
- 場所の独特な特徴を捉えたオリジナルの描写
- 平凡な説明ではなく魅力的なストーリーテリング
- 歴史的事実 + 人間的感情 + 現場への没入感

### 5. **動的チャプター構成**
- **場所の規模と特徴に基づいて適切な数のチャプターを生成**
- **小規模な場所：3-4個、中規模：5-6個、大規模複合施設：7-8個**
- **🔴 重要：route.stepsとrealTimeGuide.chaptersの数とタイトルの完璧な一致**

### 6. **📍 位置説明必須含有**
各チャプターには正確な位置説明を含める必要があります：
- **description**: そのチャプター地点の具体的位置説明
- **位置精度**: 実際観光地内の具体的場所や区域説明
- **注意**: 座標（coordinates）はシステムで自動処理されるため含有しないでください

**🚨 位置説明例示:**
"description": "清水寺仁王門入口"

**⚠️ 注意事項:**
- 座標（coordinates）オブジェクトは絶対に含有しないでください
- システムでEnhanced Location Serviceで正確な座標を自動生成します

## 💡 オーディオガイド執筆例

**❌ 悪い例（分断的、テンプレート式、事実検証不足）**:
- sceneDescription: "清水寺は清水寺の正門です。高さは20メートルです。"（推測的数値）
- coreNarrative: "778年に建設されました。日帝強占期に移転されました。"（事実確認表現なし）
- humanStories: "延鎮上人が扁額を書きました。復元工事がありました。"（検証されていない内容）

**✅ 改善された自然な例（背景知識 + 拡張された現場観察）**:
- sceneDescription: "清水寺は京都東山に佇む古刹として、1200年以上にわたって人々の信仰を集め続けています。音羽山の中腹に建つその姿は、四季折々の自然と調和し、特に桜や紅葉の季節には息をのむような美しさを見せてくれます。全体的に見ると、本堂から張り出した清水の舞台が最も印象的で、京都市街を一望できる絶景ポイントとなっています。近くで観察してみると、釘を一本も使わない懸造り（かけづくり）という伝統的な建築技法で支えられており、その技術的な素晴らしさを感じることができます。特に舞台を支える139本の柱の組み合わせと、屋根の美しい曲線を見ていると、古代の職人たちの卓越した技術に驚かされます。しかし、この寺院がなぜこの場所に建てられ、なぜこれほど多くの人々に愛され続けているのでしょうか？"
- coreNarrative: "その答えは778年、延鎮上人が音羽の滝で修行していた時に遡ります。ある夜、観音菩薩のお告げを受けた延鎮上人は、坂上田村麻呂と出会い、共にこの地に観音堂を建立しました。清水寺という名前は、音羽の滝の清らかな水に由来しており、この水は今でも「黄金水」「延命水」として参拝者に親しまれています。平安時代から江戸時代にかけて、「清水へ参る」ことは京都の人々にとって人生の節目を刻む大切な行事でした。記録によると、平安貴族たちは恋愛成就や願い事を込めて、この舞台から飛び降りる「清水の舞台から飛び降りる」という慣習がありましたが、実際には多くの人が下の木々に助けられて無事でした。しかし、この寺の真の魅力は建物の美しさだけではありません..."
- humanStories: "それは、ここで繰り広げられた無数の人間ドラマにあります。江戸時代の文献に記録されている話によると、恋に悩む若い女性たちが清水の舞台から身を投げれば恋が叶うという俗信がありました。しかし、当時の住職たちは、そのような危険な行為を止めさせるため、舞台の下により多くの木を植え、「飛び込まずとも観音様は願いを聞いてくださる」と説いて回りました。実際に、ある住職の記録には「今日も三人の若い女性を思いとどまらせることができた」という記述があり、この慈悲深い行動が現在も参拝者の心を温かく包んでいます。"

## 📐 最終JSON構造：
${JSON.stringify(AUDIO_GUIDE_EXAMPLE, null, 2)}

## ✅ 最終チェックリスト
- [ ] すべてのテキストが${langConfig.name}で書かれている
- [ ] route.stepsとrealTimeGuide.chaptersの完璧な一致
- [ ] 3つのフィールドが8-9分のストーリーに自然に接続されている
- [ ] nextDirectionは移動案内のみを別途処理
- [ ] テンプレート表現ではなく自然でオリジナルなストーリーテリング
- [ ] **📍 すべてのチャプターに正確な座標情報含有（lat、lng、description）**
- [ ] 100%正確なJSON構文

**🔴 コア強化要約 🔴**
1. **3つのフィールドのみ接続**: nextDirectionは別途処理
2. **自然な接続**: テンプレートではなく状況に適した多様な表現
3. **オリジナルなストーリーテリング**: 場所の特徴を反映した独特な描写
4. **完全な分離**: 移動案内はnextDirectionでのみ
5. **📍 座標必須**: すべてのチャプターに正確なGPS座標必須
6. **🎯 絶対事実性遵守**: 検証可能な事実のみ使用、推測や仮定絶対禁止

**今すぐ"${locationName}"の自然で魅力的なオーディオガイドを純粋なJSON形式で生成してください！**`;

  return prompt;
};

/**
 * 日本語最終ガイド生成プロンプト（index.ts互換用）
 */
export const createJapaneseFinalPrompt = (
  locationName: string,
  researchData: any,
  userProfile?: UserProfile
): string => {
  const langConfig = LANGUAGE_CONFIGS.ja;
  const audioStyle = AUDIO_GUIDE_INSTRUCTIONS.ja;
  
  // 位置タイプ分析と専門ガイド設定
  const locationType = analyzeLocationType(locationName);
  const typeConfig = LOCATION_TYPE_CONFIGS[locationType];

  const userContext = userProfile ? `
👤 ユーザーカスタマイズ情報：
- 興味・関心：${userProfile.interests?.join('、') || '一般'}
- 年齢層：${userProfile.ageGroup || '大人'}
- 知識レベル：${userProfile.knowledgeLevel || '中級'}
- 同行者：${userProfile.companions || '一人'}
` : '👤 一般観光客対象';

  const specialistContext = typeConfig ? `
🎯 専門分野ガイド設定：
- 検出された場所タイプ：${locationType}
- エキスパート役割：${typeConfig.expertRole}
- 重点分野：${typeConfig.focusAreas.join('、')}
- 特別要件：${typeConfig.specialRequirements}
` : '';

  const prompt = `# 🎙️ "${locationName}" 最終オーディオガイド生成

## 🎭 あなたの役割
${audioStyle.style}

${specialistContext}

## 📚 研究データに基づくガイド作成
以下に提供された詳細な研究データに基づいて、より正確で豊富なオーディオガイドを作成してください。

### 研究データ：
${JSON.stringify(researchData, null, 2)}

${userContext}

## 📐 最終ガイド作成指針

### 1. **研究データの活用**
- 提供されたすべての情報を自然にストーリーテリングに織り込む
- 歴史的事実、日付、人物情報を正確に反映
- 研究で発見された興味深い逸話や隠れた物語を積極的に活用

### 2. **オーディオスクリプトの品質**
- 研究データの堅い情報を親しみやすい口語調に変換
- 専門的な内容を分かりやすく面白く解説
- 聞き手が飽きないようドラマチックな構成

### 3. **強化されたコンテンツ**
- 研究データに基づいて各チャプターをより詳細に
- 具体的な数値、日付、人物名を正確に含める
- 研究で得た洞察でストーリーテリングを強化

### 4. **強化されたコンテンツ基準（日本語基準 - チャプター当たり1600文字目標）**
- sceneDescription: 500-600文字以上（背景知識 + 拡張された現場観察で向上した現場感）
- coreNarrative: 800-1000文字以上（歴史的事実と意味の詳細な説明）
- humanStories: 300-400文字以上（具体的な人物の逸話とエピソード）
- nextDirection: 200-300文字以上（明確な移動経路と距離案内）

## 📐 最終JSON構造：
${JSON.stringify(AUDIO_GUIDE_EXAMPLE, null, 2)}

## ✅ 品質チェックリスト
- [ ] 研究データのすべての重要情報を反映
- [ ] 歴史的事実と日付の正確性
- [ ] 自然なストーリーテリングの流れ
- [ ] オーディオとして聞いても退屈しない構成
- [ ] 各チャプター8-10分の豊富なコンテンツ
- [ ] 3つのフィールドが一つのスクリプトとして途切れなく接続

**🔴 必須遵守事項 🔴**
各チャプターは一人が8分間連続で話すものです！
sceneDescription → coreNarrative → humanStoriesが
水のように自然に繋がる必要があります。
絶対に各フィールドを独立したセクションとして書かないでください！

**研究データを完璧に活用して"${locationName}"の最高のオーディオガイドを作成してください！**`;

  return prompt;
};

/**
 * 構造生成プロンプト（概要+ルートのみ）
 */
export const createJapaneseStructurePrompt = (
  locationName: string,
  language: string = 'ja',
  userProfile?: UserProfile
): string => {
  const langConfig = LANGUAGE_CONFIGS[language] || LANGUAGE_CONFIGS.ja;
  const userContext = userProfile ? `
👤 ユーザーカスタマイズ情報：
- 興味・関心：${userProfile.interests?.join('、') || '一般'}
- 年齢層：${userProfile.ageGroup || '大人'}
` : '👤 一般観光客対象';

  // 位置タイプ分析と推奨スポット数情報
  const locationType = analyzeLocationType(locationName);
  const typeConfig = LOCATION_TYPE_CONFIGS[locationType] || LOCATION_TYPE_CONFIGS.general;
  const spotCount = getRecommendedSpotCount(locationName);

  return `# 🏗️ "${locationName}" ガイド基本構造生成

## 🎯 ミッション
"${locationName}"の**基本構造（概観+ルート）のみ**を生成してください。
リアルタイムガイドチャプターはタイトルのみ含め、詳細内容は生成しないでください。

${userContext}

## 🎯 場所分析情報
- 検出された場所タイプ：${locationType}
- 推奨スポット数：${typeConfig.recommendedSpots}
- 最適スポット範囲：${spotCount.min}-${spotCount.max}個
- 推奨デフォルト：${spotCount.default}個

## 📋 出力形式
純粋なJSONのみを返してください。コードブロックや説明なし、JSONのみ。

**スポット数決定ガイドライン：**
- **小規模単一建物/店舗**：3-4スポット
- **中規模観光地**：5-6スポット  
- **大規模複合施設/宮殿**：7-8スポット
- **自然公園/遊歩道**：主要ビューポイント別に4-6個
- **グルメツアーエリア**：食べ物の種類により5-8個

### 構造例（場所に合わせてスポット数調整）：
{
  "content": {
    "overview": {
      "title": "${locationName}",
      "location": "📍 地域名のみ（例：📍 京都府京都市）",
      "keyFeatures": "✨ 核心キーワード（例：✨ 音羽山の古刹）",
      "background": "🏛️ 一行要約（例：🏛️ 778年創建の観音霊場）",
      "narrativeTheme": "核心テーマ一行",
      "keyFacts": [
        { "title": "主要情報1", "description": "説明" },
        { "title": "主要情報2", "description": "説明" }
      ],
      "visitInfo": {
        "duration": "適切な所要時間",
        "difficulty": "難易度",
        "season": "最適な季節"
      }
    },
    "mustVisitSpots": "🎯 #場所1 #場所2 #場所3 #場所4 #場所5",
    "route": {
      "steps": [
        { "step": 1, "location": "入口", "title": "地点1タイトル" },
        { "step": 2, "location": "主要地点1", "title": "地点2タイトル" },
        { "step": 3, "location": "主要地点2", "title": "地点3タイトル" }
        // ... 場所特性に合った適切な数のスポット
      ]
    },
    "realTimeGuide": {
      "chapters": [
        { "id": 0, "title": "地点1タイトル" },
        { "id": 1, "title": "地点2タイトル" },
        { "id": 2, "title": "地点3タイトル" }
        // ... route.stepsと完全に同じ数
      ]
    }
  }
}

**重要事項**： 
- route.stepsとrealTimeGuide.chaptersのタイトルは完全に同一である必要がある
- **場所の規模と特徴を考慮して適切な数のスポットを構成**（3-8個の範囲内）
- 入口 → 主要地点 → 終了/出口の自然な動線
- チャプターにはタイトルのみ含め、詳細内容なし
- 純粋なJSONのみ返す、説明やコードブロックなし`;
};

/**
 * チャプター詳細生成プロンプト
 */
export const createJapaneseChapterPrompt = (
  locationName: string,
  chapterIndex: number,
  chapterTitle: string,
  existingGuide: any,
  language: string = 'ja',
  userProfile?: UserProfile
): string => {
  const langConfig = LANGUAGE_CONFIGS[language] || LANGUAGE_CONFIGS.ja;

  return `🎙️ "${locationName}" 第${chapterIndex + 1}章："${chapterTitle}" 完全オーディオガイド生成

🎯 ミッション
プロの観光ガイドとして、"${chapterTitle}"地点で観光客に語る**完全で詳細な**オーディオガイドスクリプトを作成する必要があります。

📚 既存ガイドコンテキスト
${JSON.stringify(existingGuide, null, 2)}

🚨 **絶対重要 - 完全な内容必須**
- narrativeフィールドに**最低1500-1600文字の完全な内容**を書く（絶対に短く書かないでください！）
- **背景知識 + 拡張された現場観察（アウトライン → 詳細）** 順序で現場描写 + 歴史的背景 + 人物の物語を**一つの自然な物語**として統合
- AIが「...詳細は後ほど...」のような未完成表現を絶対に使用禁止
- **完全で豊富な実際のガイドレベルの内容**を作成してください

📝 執筆構造（一つのnarrativeとして自然に接続）
1. **現場描写**（400-500文字）：訪問者が実際に見て感じることができる生き生きとした場面
2. **歴史的背景**（600-700文字）：この場所の歴史、建築的特徴、文化的意義
3. **人物の物語**（300-400文字）：実際の歴史的人物や検証された逸話
4. **次の移動案内**（100-200文字）：具体的な経路と次の場所の予告

🎭 スタイルガイド
- 親しみやすい口語調（「ここで注目すべきは」「興味深い事実は」「物語を聞くと」など）
- 教育的でありながら面白いストーリーテリング
- まるで隣で友人が説明してくれるような親しみやすさ
- **各部分が自然に続く一つの完全な物語**

🚫 **絶対禁止事項**
- 「こんにちは」「皆さん！」「はい、皆さん！」などの挨拶語は絶対使用禁止（チャプター1から）
- 「...については後でより詳しく...」「...間もなくより詳細な内容が...」などの未完成表現禁止
- 短く適当に書くことを禁止 - **必ず1500-1600文字の豊富な内容**

✅ **推奨開始表現**
- "この場所で..." "ここで注目すべきは..." "興味深いことに..."
- "目の前に見える..." "この場所では..."
- "今私たちは..." "続いて..." "次にお会いするのは..."

✅ 必須出力形式
**重要：純粋なJSONのみ出力してください。コードブロックや説明なし！**

{
  "chapter": {
    "id": ${chapterIndex},
    "title": "${chapterTitle}",
    "narrative": "この場所で最初に目に入るのは... [現場の生き生きとした描写を400-500文字で詳細に作成] しかし、なぜこの場所がこれほど特別なのでしょうか？それは[時期]に[歴史的背景と意義を600-700文字で詳細に説明] この歴史の中には本当に感動的な人物たちの物語があります。[実際の歴史的人物や検証された逸話を400-500文字で豊富に叙述] さて、こうした意味深い物語を心に刻みながら、次の地点へ移動してみましょう。[具体的な移動経路と次の場所の予告を200-300文字で]（合計1600-1900文字の完全な物語）",
    "nextDirection": "現在の位置から[基準点：メイン建物/壁/道]に沿って[方向：北/南/東/西/北東/北西/南東/南西]へ正確に[数字]メートル進んでください。途中で[経路の特徴：噴水/彫刻/看板/階段]を通り過ぎると、[到着の目印：特定の建物/看板/入口]が見えてきます。徒歩約[数字]分です。"
  }
}

🚨 JSON安全性必須規則 🚨
1. **段落区分**: オンリー「 \\n\\n 」（スペース+バックスラッシュn+バックスラッシュn+スペース）でのみ区分
2. **実際の改行禁止**: テキストに実際のEnterや改行を絶対使用禁止
3. **タブ文字禁止**: \\tや実際のタブ文字使用禁止
4. **一行作成**: すべてのJSONを一行で連結して作成
5. **引用符エスケープ**: テキスト内引用符は必ず\\"でエスケープ

**段落区分正しい例:**
"narrative": "第一段落内容です。 \\n\\n 第二段落内容です。 \\n\\n 第三段落内容です。"

**絶対禁止例:**
"narrative": "第一段落
第二段落" // ← 実際の改行禁止！

🚨 絶対遵守要項 🚨
- **narrativeフィールドは必ず1500-1600文字（最低1500文字！）**
- **背景知識 + 拡張された現場観察（アウトライン → 詳細） 順序で構成された自然なフロー**
- 序文や説明なしで直接JSONを開始
- コードブロック表示絶対禁止  
- 文法的に完璧なJSON形式
- 未完成内容や「後で補完」のような表現は絶対禁止

今すぐ"${chapterTitle}"チャプターの**完全で豊富な**オーディオガイドを生成してください！`;
};

// Functions are already exported individually above